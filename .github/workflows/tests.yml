name: ğŸ§ª æµ‹è¯•å’Œä»£ç è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  UV_CACHE_DIR: ~/.cache/uv

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ - å¿«é€Ÿå¤±è´¥
  lint:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ”§ å®‰è£… uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"
        enable-cache: true
    
    - name: ğŸ è®¾ç½® Python
      run: uv python install ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: uv sync --extra dev --extra test
    
    - name: ğŸ§¹ Ruff ä»£ç æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œ Ruff ä»£ç æ£€æŸ¥..."
        uv run ruff check src/ tests/ --output-format=github
        
    - name: ğŸ¨ Ruff æ ¼å¼åŒ–æ£€æŸ¥
      run: |
        echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
        uv run ruff format --check src/ tests/
        
    - name: ğŸ” MyPy ç±»å‹æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡Œ MyPy ç±»å‹æ£€æŸ¥..."
        uv run mypy src/

  # å•å…ƒæµ‹è¯• - å¤šå¹³å°å’Œå¤šç‰ˆæœ¬
  test:
    name: ğŸ§ª æµ‹è¯• (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: lint  # åªæœ‰ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡åæ‰è¿è¡Œæµ‹è¯•
    strategy:
      fail-fast: false  # å³ä½¿ä¸€ä¸ªä»»åŠ¡å¤±è´¥ï¼Œå…¶ä»–ä»»åŠ¡ä»ç„¶ç»§ç»­
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.11", "3.12"]
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ”§ å®‰è£… uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"
        enable-cache: true
    
    - name: ğŸ è®¾ç½® Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: uv sync --extra test
    
    - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
      run: uv run pytest tests/ -m "not integration" --cov=billing_sdk --cov-report=term-missing -vgi

  # é›†æˆæµ‹è¯•
  integration-test:
    name: ğŸ”— é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ”§ å®‰è£… uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"
        enable-cache: true
    
    - name: ğŸ è®¾ç½® Python
      run: uv python install ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: uv sync --extra test
    
    - name: ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•
      run: uv run pytest tests/ -m integration -v --tb=short
    
    - name: ğŸ“‹ è¿è¡Œç¤ºä¾‹æµ‹è¯•
      run: uv run pytest tests/test_examples.py -v

  # æ„å»ºæ£€æŸ¥
  build:
    name: ğŸ“¦ æ„å»ºæ£€æŸ¥
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ”§ å®‰è£… uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"
        enable-cache: true
    
    - name: ğŸ è®¾ç½® Python
      run: uv python install ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–
      run: uv sync --extra dev
    
    - name: ğŸ—ï¸ æ„å»ºåŒ…
      run: |
        echo "ğŸ—ï¸ æ„å»º Python åŒ…..."
        uv build
        
    - name: ğŸ“‹ æ£€æŸ¥åŒ…ä¿¡æ¯
      run: |
        echo "ğŸ“‹ æ£€æŸ¥æ„å»ºçš„åŒ…..."
        ls -la dist/
        echo "âœ… åŒ…æ„å»ºå®Œæˆ"

  # æ€§èƒ½æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  performance:
    name: âš¡ æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'performance')
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ”§ å®‰è£… uv
      uses: astral-sh/setup-uv@v2
      with:
        version: "latest"
        enable-cache: true
    
    - name: ğŸ è®¾ç½® Python
      run: uv python install ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: uv sync --extra test
    
    - name: âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
        uv run pytest tests/ --durations=10 --tb=short
        echo "ğŸ“Š æµ‹è¯•æ‰§è¡Œæ—¶é—´ç»Ÿè®¡å®Œæˆ"

  # ç»¼åˆçŠ¶æ€æ£€æŸ¥
  all-checks:
    name: âœ… æ‰€æœ‰æ£€æŸ¥å®Œæˆ
    runs-on: ubuntu-latest
    needs: [lint, test, integration-test, build]
    if: always()
    
    steps:
    - name: ğŸ“Š æ£€æŸ¥ç»“æœ
      run: |
        echo "ğŸ“Š CI/CD æ£€æŸ¥ç»“æœæ±‡æ€»ï¼š"
        echo "ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.lint.result }}"
        echo "å•å…ƒæµ‹è¯•: ${{ needs.test.result }}"
        echo "é›†æˆæµ‹è¯•: ${{ needs.integration-test.result }}"
        echo "æ„å»ºæ£€æŸ¥: ${{ needs.build.result }}"
        
        if [[ "${{ needs.lint.result }}" != "success" || "${{ needs.test.result }}" != "success" || "${{ needs.integration-test.result }}" != "success" || "${{ needs.build.result }}" != "success" ]]; then
          echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥"
          exit 1
        else
          echo "âœ… æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡äº†ï¼"
        fi 